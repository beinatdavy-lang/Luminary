<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Luminary">
<meta name="theme-color" content="#0f0f14">
<title>Luminary</title>
<link rel="manifest" href="manifest.json">
<style>
:root {
  --bg: #0f0f14;
  --card: #17171f;
  --card2: #1e1e28;
  --line: rgba(255,255,255,0.08);
  --txt: #edeae3;
  --muted: #6a6778;
  --gold: #c9a96e;
  --blue: #6fa3c0;
  --red: #d16b6b;
  --purple: #8b72c8;
  --green: #6fa88a;
  --safe-t: env(safe-area-inset-top,0px);
  --safe-b: env(safe-area-inset-bottom,0px);
  --safe-l: env(safe-area-inset-left,0px);
  --safe-r: env(safe-area-inset-right,0px);
}
* { box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent; }

html, body { height:100%; background:var(--bg); color:var(--txt); font-family:-apple-system,BlinkMacSystemFont,'SF Pro Text',sans-serif; font-size:15px; }

/* â”€â”€ LAYOUT â”€â”€ */
.shell { display:flex; height:100vh; height:100dvh; }

/* â”€â”€ SIDEBAR (Mac) â”€â”€ */
.sidebar {
  width:260px; flex-shrink:0; background:var(--card);
  border-right:1px solid var(--line);
  display:flex; flex-direction:column;
  padding-top:calc(28px + var(--safe-t));
  padding-bottom:calc(20px + var(--safe-b));
  overflow-y:auto;
}
.logo { padding:0 20px 24px; }
.logo-mark { font-size:22px; letter-spacing:.02em; font-weight:600; color:var(--gold); }
.logo-sub { font-size:11px; color:var(--muted); margin-top:2px; letter-spacing:.04em; }

.nav { padding:0 10px; flex:1; }
.nav-group { margin-bottom:24px; }
.nav-group-label { font-size:11px; font-weight:600; color:var(--muted); letter-spacing:.06em; text-transform:uppercase; padding:0 10px; margin-bottom:6px; }
.nav-btn {
  display:flex; align-items:center; gap:10px; width:100%;
  padding:9px 10px; border-radius:8px; background:none; border:none;
  color:var(--muted); font-size:14px; cursor:pointer; text-align:left;
  transition:all .15s; font-family:inherit;
}
.nav-btn:hover { background:var(--card2); color:var(--txt); }
.nav-btn.active { background:rgba(201,169,110,.12); color:var(--gold); }
.nav-btn .ico { width:20px; text-align:center; font-size:15px; flex-shrink:0; }
.nav-btn .badge {
  margin-left:auto; background:var(--card2); color:var(--muted);
  font-size:11px; padding:1px 7px; border-radius:20px; font-weight:500;
}
.nav-btn.active .badge { background:rgba(201,169,110,.15); color:var(--gold); }

.sidebar-add {
  margin:0 10px;
  display:flex; align-items:center; gap:10px;
  padding:10px 12px; border-radius:10px;
  background:var(--gold); color:#0f0f14;
  font-size:14px; font-weight:600; cursor:pointer;
  border:none; font-family:inherit; transition:opacity .15s;
}
.sidebar-add:hover { opacity:.88; }
.sidebar-add .ico { font-size:18px; }

/* â”€â”€ MAIN â”€â”€ */
.main { flex:1; display:flex; flex-direction:column; overflow:hidden; min-width:0; }

/* â”€â”€ TOPBAR â”€â”€ */
.topbar {
  display:flex; align-items:center; gap:10px;
  padding:14px 20px; padding-top:calc(14px + var(--safe-t));
  border-bottom:1px solid var(--line); background:var(--bg);
  flex-shrink:0;
}
.topbar-title { font-size:18px; font-weight:600; flex:1; }
.search {
  display:flex; align-items:center; gap:8px;
  background:var(--card); border:1px solid var(--line);
  border-radius:10px; padding:8px 12px; flex:1; max-width:320px;
}
.search input { background:none; border:none; outline:none; color:var(--txt); font-size:14px; flex:1; font-family:inherit; }
.search input::placeholder { color:var(--muted); }
.search-ico { color:var(--muted); font-size:15px; }

/* â”€â”€ CONTENT â”€â”€ */
.content { flex:1; overflow-y:auto; padding:20px; }
.content::-webkit-scrollbar { width:4px; }
.content::-webkit-scrollbar-thumb { background:var(--card2); border-radius:2px; }

/* â”€â”€ CAPTURE PANEL (shown when ?capture params present) â”€â”€ */
.capture-panel {
  position:fixed; inset:0; z-index:500;
  background:var(--bg);
  display:flex; flex-direction:column;
  padding:calc(16px + var(--safe-t)) 16px calc(16px + var(--safe-b));
  overflow-y:auto;
}
.capture-panel.hidden { display:none; }
.capture-header { display:flex; align-items:center; gap:10px; margin-bottom:20px; }
.capture-header h2 { font-size:20px; font-weight:600; flex:1; }
.capture-cancel { color:var(--muted); font-size:15px; cursor:pointer; padding:4px 10px; }

/* â”€â”€ FIELD â”€â”€ */
.field { margin-bottom:14px; }
.field label { display:block; font-size:12px; font-weight:600; color:var(--muted); letter-spacing:.04em; text-transform:uppercase; margin-bottom:6px; }
.field input, .field textarea, .field select {
  width:100%; background:var(--card); border:1px solid var(--line);
  border-radius:10px; padding:12px 14px; color:var(--txt);
  font-size:15px; outline:none; font-family:inherit;
  transition:border-color .15s; resize:vertical;
}
.field input:focus, .field textarea:focus { border-color:var(--gold); }
.field textarea { min-height:90px; }
.field select option { background:var(--card); }

/* source chips */
.source-chips { display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap; }
.chip {
  padding:8px 16px; border-radius:20px; font-size:13px; font-weight:500;
  background:var(--card); border:1px solid var(--line);
  color:var(--muted); cursor:pointer; transition:all .15s;
}
.chip.active-web   { background:rgba(111,163,192,.15); border-color:rgba(111,163,192,.5); color:var(--blue); }
.chip.active-email { background:rgba(201,169,110,.12); border-color:rgba(201,169,110,.4); color:var(--gold); }
.chip.active-yt    { background:rgba(209,107,107,.12); border-color:rgba(209,107,107,.4); color:var(--red); }
.chip.active-pdf   { background:rgba(139,114,200,.12); border-color:rgba(139,114,200,.4); color:var(--purple); }

.save-btn {
  width:100%; padding:16px; border-radius:14px;
  background:var(--gold); color:#0f0f14;
  font-size:17px; font-weight:700; border:none;
  cursor:pointer; margin-top:8px; font-family:inherit;
  transition:opacity .15s;
}
.save-btn:hover { opacity:.88; }
.save-btn:active { transform:scale(.98); }

/* â”€â”€ HIGHLIGHT CARDS â”€â”€ */
.cards-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:12px; }

.hcard {
  background:var(--card); border:1px solid var(--line);
  border-radius:14px; padding:16px; cursor:pointer;
  transition:all .2s; position:relative;
  border-left:3px solid transparent;
}
.hcard.web   { border-left-color:var(--blue); }
.hcard.email { border-left-color:var(--gold); }
.hcard.youtube { border-left-color:var(--red); }
.hcard.pdf   { border-left-color:var(--purple); }
.hcard:hover { background:var(--card2); transform:translateY(-1px); }

.hcard-meta { display:flex; align-items:center; gap:8px; margin-bottom:10px; }
.type-pill {
  font-size:10px; font-weight:600; letter-spacing:.05em; text-transform:uppercase;
  padding:2px 8px; border-radius:20px;
}
.type-pill.web    { background:rgba(111,163,192,.15); color:var(--blue); }
.type-pill.email  { background:rgba(201,169,110,.12); color:var(--gold); }
.type-pill.youtube{ background:rgba(209,107,107,.12); color:var(--red); }
.type-pill.pdf    { background:rgba(139,114,200,.12); color:var(--purple); }
.hcard-source { font-size:12px; color:var(--muted); flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.hcard-date { font-size:11px; color:var(--muted); flex-shrink:0; }

.hcard-quote {
  font-size:15px; line-height:1.55; color:var(--txt);
  margin-bottom:8px;
  display:-webkit-box; -webkit-line-clamp:4; -webkit-box-orient:vertical; overflow:hidden;
}
.hcard-note { font-size:13px; color:var(--muted); margin-bottom:8px; line-height:1.4; }
.hcard-tags { display:flex; gap:6px; flex-wrap:wrap; margin-bottom:10px; }
.tag { font-size:11px; padding:2px 8px; border-radius:20px; background:var(--card2); color:var(--muted); }

.hcard-actions { display:flex; gap:6px; flex-wrap:wrap; opacity:0; transition:opacity .15s; }
.hcard:hover .hcard-actions { opacity:1; }
.act {
  font-size:11px; padding:4px 10px; border-radius:6px;
  background:var(--card2); border:1px solid var(--line);
  color:var(--muted); cursor:pointer; transition:all .1s;
}
.act:hover { color:var(--txt); border-color:rgba(255,255,255,.15); }
.act.obs { color:var(--purple); border-color:rgba(139,114,200,.3); }
.act.obs:hover { background:rgba(139,114,200,.12); }

/* â”€â”€ STATS â”€â”€ */
.stats { display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:12px; margin-bottom:24px; }
.stat { background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px; }
.stat-n { font-size:36px; font-weight:300; color:var(--gold); line-height:1; }
.stat-l { font-size:12px; color:var(--muted); margin-top:4px; }

/* â”€â”€ DAILY â”€â”€ */
.daily {
  background:linear-gradient(135deg,rgba(201,169,110,.07),rgba(139,114,200,.04));
  border:1px solid rgba(201,169,110,.18);
  border-radius:16px; padding:20px; margin-bottom:24px;
}
.daily-label { font-size:11px; font-weight:600; letter-spacing:.08em; text-transform:uppercase; color:var(--gold); margin-bottom:10px; }
.daily-quote { font-size:17px; line-height:1.6; margin-bottom:8px; font-style:italic; }
.daily-source { font-size:13px; color:var(--muted); }
.daily-actions { display:flex; gap:8px; margin-top:14px; }

/* â”€â”€ SECTION â”€â”€ */
.sec-head { display:flex; align-items:center; gap:10px; margin-bottom:14px; }
.sec-head h3 { font-size:16px; font-weight:600; }
.sec-head .sub { font-size:13px; color:var(--muted); }

/* â”€â”€ EMPTY â”€â”€ */
.empty { text-align:center; padding:60px 20px; color:var(--muted); }
.empty .ico { font-size:36px; margin-bottom:12px; opacity:.4; }
.empty p { font-size:15px; }

/* â”€â”€ DETAIL MODAL â”€â”€ */
.overlay { position:fixed; inset:0; background:rgba(0,0,0,.65); backdrop-filter:blur(10px); z-index:300; display:flex; align-items:flex-end; justify-content:center; opacity:0; pointer-events:none; transition:opacity .2s; }
.overlay.open { opacity:1; pointer-events:all; }
.sheet {
  background:var(--card); border-radius:20px 20px 0 0;
  width:100%; max-width:680px; max-height:85vh; overflow-y:auto;
  padding:20px 20px calc(20px + var(--safe-b));
  transform:translateY(100%); transition:transform .25s cubic-bezier(.4,0,.2,1);
}
.overlay.open .sheet { transform:translateY(0); }
.sheet-handle { width:36px; height:4px; background:var(--line); border-radius:2px; margin:0 auto 20px; }
.sheet-type-pill { display:inline-flex; align-items:center; gap:6px; margin-bottom:14px; }
.sheet-quote {
  font-size:18px; line-height:1.65; margin-bottom:16px;
  padding:16px; background:var(--card2); border-radius:12px;
  border-left:3px solid var(--gold); font-style:italic;
}
.sheet-note { font-size:14px; color:var(--muted); margin-bottom:14px; padding:12px; background:var(--card2); border-radius:10px; }
.sheet-footer { display:flex; gap:8px; flex-wrap:wrap; margin-top:16px; }
.btn {
  display:inline-flex; align-items:center; gap:6px;
  padding:10px 16px; border-radius:10px; font-size:14px; font-weight:500;
  border:1px solid var(--line); background:var(--card2); color:var(--txt);
  cursor:pointer; transition:all .15s; font-family:inherit;
}
.btn:hover { border-color:rgba(255,255,255,.15); }
.btn.obs { color:var(--purple); border-color:rgba(139,114,200,.3); }
.btn.obs:hover { background:rgba(139,114,200,.1); }
.btn.danger { color:var(--red); border-color:rgba(209,107,107,.3); }

/* â”€â”€ OBSIDIAN CONFIG â”€â”€ */
.obs-section { background:rgba(139,114,200,.05); border:1px solid rgba(139,114,200,.2); border-radius:14px; padding:20px; margin-bottom:16px; }
.obs-section h4 { font-size:15px; font-weight:600; color:var(--purple); margin-bottom:8px; }
.obs-section p { font-size:13px; color:var(--muted); line-height:1.6; margin-bottom:14px; }
.obs-row { display:flex; gap:8px; }
.obs-row input { flex:1; }
.md-box { background:var(--card2); border:1px solid var(--line); border-radius:8px; padding:12px; font-size:11px; font-family:'SF Mono',monospace; color:var(--muted); line-height:1.8; margin-top:12px; white-space:pre-wrap; word-break:break-word; }

/* â”€â”€ MOBILE NAV â”€â”€ */
.mob-nav {
  display:none; position:fixed; bottom:0; left:0; right:0;
  background:rgba(15,15,20,.95); backdrop-filter:blur(20px);
  border-top:1px solid var(--line);
  padding:6px 0 calc(6px + var(--safe-b));
  z-index:200;
}
.mob-nav-row { display:flex; justify-content:space-around; }
.mob-btn { display:flex; flex-direction:column; align-items:center; gap:3px; cursor:pointer; padding:6px 14px; color:var(--muted); border:none; background:none; font-family:inherit; }
.mob-btn .ico { font-size:22px; }
.mob-btn .lbl { font-size:10px; font-weight:500; letter-spacing:.02em; }
.mob-btn.active { color:var(--gold); }

.mob-capture-btn {
  display:none; position:fixed; bottom:calc(72px + var(--safe-b)); right:20px;
  width:56px; height:56px; border-radius:28px;
  background:var(--gold); color:#0f0f14;
  font-size:28px; align-items:center; justify-content:center;
  border:none; cursor:pointer;
  box-shadow:0 4px 24px rgba(201,169,110,.35);
  z-index:200; transition:transform .15s;
}
.mob-capture-btn:active { transform:scale(.92); }

.hamburger { display:none; cursor:pointer; padding:6px; background:none; border:none; }
.hamburger span { display:block; width:20px; height:2px; background:var(--txt); margin:4px 0; border-radius:1px; }

.view { display:none; }
.view.active { display:block; }

.overlay-bg { position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:199; display:none; }
.overlay-bg.show { display:block; }

.toast {
  position:fixed; bottom:calc(24px + var(--safe-b)); left:50%;
  transform:translateX(-50%) translateY(80px);
  background:var(--card2); border:1px solid var(--line);
  border-radius:10px; padding:11px 20px; font-size:14px; font-weight:500;
  transition:transform .3s; z-index:999; pointer-events:none;
  box-shadow:0 4px 20px rgba(0,0,0,.4);
}
.toast.show { transform:translateX(-50%) translateY(0); }

/* â”€â”€ SHORTCUTS GUIDE â”€â”€ */
.guide-card { background:var(--card); border:1px solid var(--line); border-radius:14px; padding:20px; margin-bottom:14px; }
.guide-card h4 { font-size:15px; font-weight:600; margin-bottom:8px; }
.guide-card p { font-size:13px; color:var(--muted); line-height:1.65; margin-bottom:12px; }
.steps { display:flex; flex-direction:column; gap:10px; }
.step { display:flex; gap:12px; align-items:flex-start; }
.step-n { width:24px; height:24px; border-radius:12px; background:var(--gold); color:#0f0f14; font-size:12px; font-weight:700; display:flex; align-items:center; justify-content:center; flex-shrink:0; margin-top:1px; }
.step-txt { font-size:13px; color:var(--muted); line-height:1.6; }
.step-txt strong { color:var(--txt); }
.url-box { background:var(--card2); border:1px solid var(--line); border-radius:8px; padding:10px 14px; font-size:12px; font-family:'SF Mono',monospace; color:var(--blue); margin-top:8px; word-break:break-all; display:flex; align-items:center; gap:8px; }
.copy-btn { background:var(--card); border:1px solid var(--line); border-radius:6px; padding:4px 10px; font-size:11px; color:var(--muted); cursor:pointer; flex-shrink:0; font-family:inherit; transition:all .1s; }
.copy-btn:hover { color:var(--txt); }

@media (max-width:760px) {
  .sidebar { position:fixed; left:0; top:0; bottom:0; z-index:200; transform:translateX(-100%); transition:transform .28s cubic-bezier(.4,0,.2,1); }
  .sidebar.open { transform:translateX(0); box-shadow:4px 0 32px rgba(0,0,0,.6); }
  .stats { grid-template-columns:repeat(2,1fr); }
  .cards-grid { grid-template-columns:1fr; }
  .hamburger { display:block; }
  .mob-nav { display:block; }
  .mob-capture-btn { display:flex; }
  .main { padding-bottom:calc(64px + var(--safe-b)); }
  .topbar { padding:12px 16px; padding-top:calc(12px + var(--safe-t)); }
  .content { padding:14px; }
  .search { max-width:none; }
  .d-only { display:none; }
  .overlay { align-items:center; }
  .sheet { border-radius:20px; margin:16px; max-height:90vh; }
}
</style>
</head>
<body>

<div class="overlay-bg" id="bgOverlay" onclick="closeSidebar()"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CAPTURE PANEL â€” affichÃ© quand ?capture=1
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="capture-panel hidden" id="capturePanel">
  <div class="capture-header">
    <h2>ğŸ’¾ Sauvegarder</h2>
    <span class="capture-cancel" onclick="closeCapture()">Annuler</span>
  </div>

  <div class="source-chips" id="sourceChips">
    <div class="chip active-web" data-src="web"    onclick="setChip('web')">ğŸŒ Web</div>
    <div class="chip"            data-src="email"  onclick="setChip('email')">âœ‰ï¸ Email</div>
    <div class="chip"            data-src="youtube" onclick="setChip('youtube')">â–¶ï¸ YouTube</div>
    <div class="chip"            data-src="pdf"    onclick="setChip('pdf')">ğŸ“„ PDF</div>
  </div>

  <div class="field">
    <label>Texte capturÃ© *</label>
    <textarea id="cpQuote" placeholder="Le passage que vous voulez retenirâ€¦" rows="5"></textarea>
  </div>
  <div class="field">
    <label>Source (titre ou auteur)</label>
    <input id="cpSource" type="text" placeholder="ex: Morning Brew, Paul Graham, Les Ã‰chosâ€¦">
  </div>
  <div class="field" id="cpUrlField">
    <label>URL <span style="color:var(--muted);font-weight:400">(optionnel)</span></label>
    <input id="cpUrl" type="url" placeholder="https://â€¦">
  </div>
  <div class="field">
    <label>Votre note <span style="color:var(--muted);font-weight:400">(optionnel)</span></label>
    <textarea id="cpNote" placeholder="Ce que Ã§a vous inspireâ€¦" rows="2"></textarea>
  </div>
  <div class="field">
    <label>Tags <span style="color:var(--muted);font-weight:400">(sÃ©parÃ©s par des virgules)</span></label>
    <input id="cpTags" type="text" placeholder="ex: IA, design, business">
  </div>

  <button class="save-btn" onclick="saveCapture()">Sauvegarder âœ“</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN APP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="shell" id="mainShell">

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="logo">
      <div class="logo-mark">âœ¦ Luminary</div>
      <div class="logo-sub">Votre mÃ©moire de lecture</div>
    </div>

    <nav class="nav">
      <div class="nav-group">
        <div class="nav-group-label">Vues</div>
        <button class="nav-btn active" onclick="go('home',this)"><span class="ico">âœ¦</span> Accueil</button>
        <button class="nav-btn" onclick="go('all',this)"><span class="ico">â—ˆ</span> Tous <span class="badge" id="bAll">0</span></button>
        <button class="nav-btn" onclick="go('review',this)"><span class="ico">âŸ³</span> Revue du jour</button>
        <button class="nav-btn" onclick="go('fav',this)"><span class="ico">â˜…</span> Favoris <span class="badge" id="bFav">0</span></button>
      </div>
      <div class="nav-group">
        <div class="nav-group-label">Par source</div>
        <button class="nav-btn" onclick="go('web',this)"><span class="ico">ğŸŒ</span> Web <span class="badge" id="bWeb">0</span></button>
        <button class="nav-btn" onclick="go('email',this)"><span class="ico">âœ‰ï¸</span> Email <span class="badge" id="bEmail">0</span></button>
        <button class="nav-btn" onclick="go('youtube',this)"><span class="ico">â–¶ï¸</span> YouTube <span class="badge" id="bYt">0</span></button>
        <button class="nav-btn" onclick="go('pdf',this)"><span class="ico">ğŸ“„</span> PDF <span class="badge" id="bPdf">0</span></button>
      </div>
      <div class="nav-group">
        <div class="nav-group-label">Outils</div>
        <button class="nav-btn" onclick="go('setup',this)"><span class="ico">âš™</span> Configuration</button>
        <button class="nav-btn" onclick="go('obsidian',this)"><span class="ico">â—†</span> Obsidian</button>
      </div>
    </nav>

    <button class="sidebar-add" onclick="openCapture()">
      <span class="ico">ï¼‹</span> Nouvelle capture
    </button>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="topbar">
      <button class="hamburger" onclick="toggleSidebar()"><span></span><span></span><span></span></button>
      <div class="topbar-title" id="topTitle">Accueil</div>
      <div class="search d-only">
        <span class="search-ico">âŒ•</span>
        <input type="text" placeholder="Rechercherâ€¦" oninput="handleSearch(this.value)">
      </div>
      <button class="btn d-only" onclick="openCapture()">ï¼‹ Capturer</button>
    </div>

    <div class="content">

      <!-- HOME -->
      <div class="view active" id="v-home">
        <div class="stats" id="statsRow"></div>
        <div class="daily hidden" id="dailyBox">
          <div class="daily-label">âœ¦ MÃ©moire du jour</div>
          <div class="daily-quote" id="dailyQ"></div>
          <div class="daily-source" id="dailyS"></div>
          <div class="daily-actions">
            <button class="btn" onclick="refreshDaily()">â†» Autre</button>
            <button class="btn obs" id="dailyObs" onclick="">â—† Obsidian</button>
          </div>
        </div>
        <div class="sec-head"><h3>RÃ©cents</h3><span class="sub" id="recentSub"></span></div>
        <div class="cards-grid" id="recentGrid"></div>
      </div>

      <!-- ALL -->
      <div class="view" id="v-all">
        <div class="cards-grid" id="allGrid"></div>
        <div class="empty hidden" id="emptyAll"><div class="ico">â—ˆ</div><p>Aucun highlight encore</p></div>
      </div>

      <!-- FILTERED VIEWS share same template -->
      <div class="view" id="v-web">
        <div class="cards-grid" id="webGrid"></div>
        <div class="empty hidden" id="emptyWeb"><div class="ico">ğŸŒ</div><p>Aucune capture web</p></div>
      </div>
      <div class="view" id="v-email">
        <div class="cards-grid" id="emailGrid"></div>
        <div class="empty hidden" id="emptyEmail"><div class="ico">âœ‰ï¸</div><p>Aucun highlight email</p></div>
      </div>
      <div class="view" id="v-youtube">
        <div class="cards-grid" id="ytGrid"></div>
        <div class="empty hidden" id="emptyYt"><div class="ico">â–¶ï¸</div><p>Aucune note YouTube</p></div>
      </div>
      <div class="view" id="v-pdf">
        <div class="cards-grid" id="pdfGrid"></div>
        <div class="empty hidden" id="emptyPdf"><div class="ico">ğŸ“„</div><p>Aucun highlight PDF</p></div>
      </div>
      <div class="view" id="v-fav">
        <div class="cards-grid" id="favGrid"></div>
        <div class="empty hidden" id="emptyFav"><div class="ico">â˜…</div><p>Aucun favori</p></div>
      </div>

      <!-- REVIEW -->
      <div class="view" id="v-review">
        <div class="sec-head"><h3>Revue du jour</h3><span class="sub">5 highlights alÃ©atoires</span></div>
        <div class="cards-grid" id="reviewGrid"></div>
      </div>

      <!-- SETUP -->
      <div class="view" id="v-setup">
        <div class="guide-card">
          <h4>ğŸ“± Raccourci Siri Shortcuts â€” Share Sheet iOS</h4>
          <p>Installez ce raccourci une seule fois. Ensuite, depuis <strong>Safari, Mail ou YouTube</strong> : bouton Partager â†’ Â« Envoyer Ã  Luminary Â» â†’ le formulaire s'ouvre prÃ©-rempli. Appuyez sur <strong>Sauvegarder</strong>. C'est tout.</p>

          <div style="background:rgba(201,169,110,.08);border:1px solid rgba(201,169,110,.2);border-radius:10px;padding:14px;margin-bottom:16px">
            <div style="font-size:12px;font-weight:600;color:var(--gold);margin-bottom:6px">VOTRE URL DE CAPTURE</div>
            <div class="url-box" id="captureUrlBox">
              <span id="captureUrlText">https://votre-app.netlify.app/?capture=1&amp;quote=TEXTE&amp;url=URL&amp;src=web</span>
              <button class="copy-btn" onclick="copyUrl()">Copier</button>
            </div>
            <div style="font-size:11px;color:var(--muted);margin-top:6px">âš  Remplacez d'abord votre-app.netlify.app par votre vraie URL</div>
          </div>

          <div class="steps">
            <div class="step">
              <div class="step-n">1</div>
              <div class="step-txt">Sur iPhone, ouvrez <strong>l'app Raccourcis</strong> (Shortcuts)</div>
            </div>
            <div class="step">
              <div class="step-n">2</div>
              <div class="step-txt">Appuyez <strong>ï¼‹</strong> â†’ <strong>Ajouter une action</strong> â†’ cherchez <strong>Â« Ouvrir URLs Â»</strong></div>
            </div>
            <div class="step">
              <div class="step-n">3</div>
              <div class="step-txt">Dans l'URL, tapez votre URL Luminary en remplaÃ§ant <code style="color:var(--blue)">TEXTE</code> par <strong>Variable â†’ EntrÃ©e du raccourci</strong></div>
            </div>
            <div class="step">
              <div class="step-n">4</div>
              <div class="step-txt">Activez <strong>Â« Afficher dans le menu Partager Â»</strong> dans les rÃ©glages du raccourci</div>
            </div>
            <div class="step">
              <div class="step-n">5</div>
              <div class="step-txt">Maintenant : sÃ©lectionnez du texte dans Safari ou Mail â†’ <strong>Partager â†’ votre raccourci</strong> â†’ Luminary s'ouvre rempli</div>
            </div>
          </div>
        </div>

        <div class="guide-card">
          <h4>ğŸŒ Bookmarklet Safari Mac</h4>
          <p>Sur Mac, glissez ce lien dans votre barre de favoris. SÃ©lectionnez du texte sur n'importe quelle page, cliquez dessus â€” Luminary s'ouvre rempli.</p>
          <div class="url-box">
            <span id="bkLetLink" style="font-size:10px;word-break:break-all;color:var(--muted)">Chargementâ€¦</span>
            <button class="copy-btn" onclick="copyBookmarklet()">Copier</button>
          </div>
          <p style="font-size:11px;color:var(--muted);margin-top:8px">Ou : Marque-pages â†’ Ajouter une page (collez le code ci-dessus comme URL)</p>
        </div>

        <div class="guide-card">
          <h4>ğŸ“„ Pour les PDFs</h4>
          <p>Depuis <strong>Fichiers</strong> ou <strong>Books</strong> sur iOS : sÃ©lectionnez du texte â†’ Partager â†’ votre raccourci, choisissez le type PDF. Sur Mac : copiez le texte â†’ ouvrez Luminary â†’ ï¼‹ Capturer â†’ PDF.</p>
        </div>
      </div>

      <!-- OBSIDIAN -->
      <div class="view" id="v-obsidian">
        <div class="obs-section">
          <h4>â—† Votre vault Obsidian</h4>
          <p>Entrez le nom exact de votre vault. Chaque highlight s'ouvrira dans Obsidian via le protocole <code style="color:var(--purple)">obsidian://</code> â€” sans plugin requis.</p>
          <div class="field"><label>Nom du vault</label>
            <div class="obs-row">
              <input id="obsVault" type="text" placeholder="ex: Mon Vault" oninput="saveObs()">
              <button class="btn obs" onclick="testObs()">â—† Tester</button>
            </div>
          </div>
          <div class="field"><label>Dossier <span style="color:var(--muted);font-weight:400">(optionnel)</span></label>
            <input id="obsFolder" type="text" placeholder="ex: Luminary / Inbox" oninput="saveObs()">
          </div>
        </div>
        <div class="obs-section">
          <h4>â—† Format de note</h4>
          <div class="md-box" id="mdPreview"></div>
        </div>
        <div class="obs-section">
          <h4>â—† Export</h4>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn obs" onclick="exportAll()">â—† Tous les highlights</button>
            <button class="btn obs" onclick="exportFavs()">â˜… Favoris seulement</button>
            <button class="btn" onclick="dlMd()">â¬‡ TÃ©lÃ©charger .md</button>
          </div>
        </div>
      </div>

    </div><!-- /content -->
  </main>
</div><!-- /shell -->

<!-- MOBILE NAV -->
<div class="mob-nav" id="mobNav">
  <div class="mob-nav-row">
    <button class="mob-btn active" id="mn-home" onclick="go('home',null,'mn-home')"><span class="ico">âœ¦</span><span class="lbl">Accueil</span></button>
    <button class="mob-btn" id="mn-all"  onclick="go('all',null,'mn-all')"><span class="ico">â—ˆ</span><span class="lbl">Tous</span></button>
    <button class="mob-btn" id="mn-rev"  onclick="go('review',null,'mn-rev')"><span class="ico">âŸ³</span><span class="lbl">Revue</span></button>
    <button class="mob-btn" id="mn-fav"  onclick="go('fav',null,'mn-fav')"><span class="ico">â˜…</span><span class="lbl">Favoris</span></button>
    <button class="mob-btn" id="mn-obs"  onclick="go('obsidian',null,'mn-obs')"><span class="ico">â—†</span><span class="lbl">Obsidian</span></button>
  </div>
</div>
<button class="mob-capture-btn" onclick="openCapture()">ï¼‹</button>

<!-- DETAIL SHEET -->
<div class="overlay" id="detailOverlay" onclick="closeDetail(event)">
  <div class="sheet" id="detailSheet">
    <div class="sheet-handle"></div>
    <div id="detailContent"></div>
    <div class="sheet-footer" id="detailFooter"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let HL = JSON.parse(localStorage.getItem('lum3_hl') || '[]');
let obsVault  = localStorage.getItem('lum3_vault')  || '';
let obsFolder = localStorage.getItem('lum3_folder') || 'Luminary';
let curSrc = 'web';
let curView = 'home';
let dailyHL = null;

// Seed demo data
if (!HL.length) {
  HL = [
    {id:'d1',type:'web',   quote:'The best ideas start as contradictions â€” something everyone believes to be impossible that turns out to be not only possible but inevitable.',source:'Paul Graham â€” How to Get Startup Ideas',url:'https://paulgraham.com',note:'',tags:['startup','idÃ©es'],date:new Date().toISOString(),fav:false},
    {id:'d2',type:'email', quote:'Attention is the most precious resource we have, and yet we give it away almost unconsciously.',source:'Dense Discovery #210 â€” Kai Brach',url:'',note:'Vrai sujet de notre Ã©poque',tags:['attention','technologie'],date:new Date(Date.now()-86400000).toISOString(),fav:true},
    {id:'d3',type:'youtube',quote:"The goal is not to manage time, it's to manage energy. Because you can always find more time, but you can't manufacture more energy.",source:'Marie Forleo â€” Everything is Figureoutable',url:'https://youtu.be/example',note:'Changer ma faÃ§on de planifier',tags:['productivitÃ©','Ã©nergie'],date:new Date(Date.now()-2*86400000).toISOString(),fav:false},
    {id:'d4',type:'pdf',   quote:'La carte n\'est pas le territoire. Toute abstraction efface des dÃ©tails qui peuvent s\'avÃ©rer cruciaux dans certains contextes.',source:'Korzybski â€” Science and Sanity',url:'',note:'',tags:['philosophie','modÃ¨les mentaux'],date:new Date(Date.now()-3*86400000).toISOString(),fav:true},
  ];
  persist();
}

function persist() { localStorage.setItem('lum3_hl', JSON.stringify(HL)); updateBadges(); }
function saveObs()  { obsVault=document.getElementById('obsVault').value; obsFolder=document.getElementById('obsFolder').value||'Luminary'; localStorage.setItem('lum3_vault',obsVault); localStorage.setItem('lum3_folder',obsFolder); updateMdPreview(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TITLES = {home:'Accueil',all:'Tous les highlights',web:'Web',email:'Email',youtube:'YouTube',pdf:'PDF',fav:'Favoris',review:'Revue du jour',setup:'Configuration',obsidian:'Obsidian'};

function go(v, navEl, mobId) {
  curView = v;
  document.querySelectorAll('.view').forEach(x=>x.classList.remove('active'));
  document.getElementById('v-'+v)?.classList.add('active');
  document.getElementById('topTitle').textContent = TITLES[v] || v;
  document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
  if(navEl) navEl.classList.add('active');
  document.querySelectorAll('.mob-btn').forEach(x=>x.classList.remove('active'));
  if(mobId) document.getElementById(mobId)?.classList.add('active');
  renderView(v); closeSidebar();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderView(v) {
  if(v==='home')    renderHome();
  else if(v==='all')    renderGrid('allGrid','emptyAll',HL);
  else if(v==='web')    renderGrid('webGrid','emptyWeb',HL.filter(h=>h.type==='web'));
  else if(v==='email')  renderGrid('emailGrid','emptyEmail',HL.filter(h=>h.type==='email'));
  else if(v==='youtube')renderGrid('ytGrid','emptyYt',HL.filter(h=>h.type==='youtube'));
  else if(v==='pdf')    renderGrid('pdfGrid','emptyPdf',HL.filter(h=>h.type==='pdf'));
  else if(v==='fav')    renderGrid('favGrid','emptyFav',HL.filter(h=>h.fav));
  else if(v==='review') renderReview();
  else if(v==='setup')  renderSetup();
  else if(v==='obsidian') renderObsidian();
}

function renderHome() {
  // Stats
  const week = HL.filter(h=>new Date(h.date)>new Date(Date.now()-7*86400000)).length;
  document.getElementById('statsRow').innerHTML = `
    <div class="stat"><div class="stat-n">${HL.length}</div><div class="stat-l">Highlights</div></div>
    <div class="stat"><div class="stat-n">${week}</div><div class="stat-l">Cette semaine</div></div>
    <div class="stat"><div class="stat-n">${HL.filter(h=>h.fav).length}</div><div class="stat-l">Favoris</div></div>
    <div class="stat"><div class="stat-n">4</div><div class="stat-l">Sources</div></div>`;
  // Daily
  if (HL.length) {
    if (!dailyHL) dailyHL = HL[Math.floor(Math.random()*HL.length)];
    document.getElementById('dailyBox').classList.remove('hidden');
    document.getElementById('dailyQ').textContent = '"' + dailyHL.quote + '"';
    document.getElementById('dailyS').textContent = 'â€” ' + dailyHL.source;
    document.getElementById('dailyObs').onclick = ()=>send2obs(dailyHL.id);
  }
  // Recent
  const recent = [...HL].sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,6);
  document.getElementById('recentSub').textContent = HL.length + ' au total';
  renderGrid('recentGrid', null, recent);
}

function refreshDaily() { dailyHL = HL[Math.floor(Math.random()*HL.length)]; renderHome(); }

function renderGrid(gridId, emptyId, items) {
  const g = document.getElementById(gridId); if(!g) return;
  g.innerHTML = items.map(h=>card(h)).join('');
  if(emptyId) {
    const e = document.getElementById(emptyId);
    if(e) { e.classList.toggle('hidden', items.length>0); }
  }
}

function renderReview() {
  renderGrid('reviewGrid', null, [...HL].sort(()=>Math.random()-.5).slice(0,5));
}

function renderSetup() {
  const base = window.location.origin + window.location.pathname;
  const url = `${base}?capture=1&quote=TEXTE&url=URL&src=web`;
  document.getElementById('captureUrlText').textContent = url;
  // Bookmarklet
  const bk = `javascript:(function(){var s=window.getSelection?window.getSelection().toString():'';window.open('${base}?capture=1&quote='+encodeURIComponent(s)+'&url='+encodeURIComponent(location.href)+'&src=web','_blank','width=480,height=700');})();`;
  document.getElementById('bkLetLink').textContent = bk;
}

function renderObsidian() {
  document.getElementById('obsVault').value  = obsVault;
  document.getElementById('obsFolder').value = obsFolder;
  updateMdPreview();
}

function card(h) {
  const typeIco = {web:'ğŸŒ',email:'âœ‰ï¸',youtube:'â–¶ï¸',pdf:'ğŸ“„'};
  const date = new Date(h.date).toLocaleDateString('fr-FR',{day:'numeric',month:'short'});
  return `
  <div class="hcard ${h.type}" onclick="openDetail('${h.id}')">
    <div class="hcard-meta">
      <span class="type-pill ${h.type}">${typeIco[h.type]||'â—ˆ'} ${h.type}</span>
      <span class="hcard-source">${esc(h.source)}</span>
      <span class="hcard-date">${date}${h.fav?' â˜…':''}</span>
    </div>
    <div class="hcard-quote">${esc(h.quote)}</div>
    ${h.note ? `<div class="hcard-note">ğŸ’­ ${esc(h.note)}</div>` : ''}
    ${h.tags.length ? '<div class="hcard-tags">'+h.tags.map(t=>`<span class="tag">${esc(t)}</span>`).join('')+'</div>' : ''}
    <div class="hcard-actions">
      <span class="act" onclick="event.stopPropagation();toggleFav('${h.id}')">${h.fav?'â˜… Retirer':'â˜† Favori'}</span>
      <span class="act" onclick="event.stopPropagation();copyText('${h.id}')">â˜ Copier</span>
      <span class="act obs" onclick="event.stopPropagation();send2obs('${h.id}')">â—† Obsidian</span>
      <span class="act" onclick="event.stopPropagation();delHL('${h.id}')">âœ•</span>
    </div>
  </div>`;
}

function updateBadges() {
  document.getElementById('bAll').textContent   = HL.length;
  document.getElementById('bFav').textContent   = HL.filter(h=>h.fav).length;
  document.getElementById('bWeb').textContent   = HL.filter(h=>h.type==='web').length;
  document.getElementById('bEmail').textContent = HL.filter(h=>h.type==='email').length;
  document.getElementById('bYt').textContent    = HL.filter(h=>h.type==='youtube').length;
  document.getElementById('bPdf').textContent   = HL.filter(h=>h.type==='pdf').length;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CAPTURE PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openCapture(prefill) {
  curSrc = (prefill && prefill.src) || 'web';
  document.getElementById('cpQuote').value  = (prefill && prefill.quote)  || '';
  document.getElementById('cpSource').value = (prefill && prefill.source) || '';
  document.getElementById('cpUrl').value    = (prefill && prefill.url)    || '';
  document.getElementById('cpNote').value   = '';
  document.getElementById('cpTags').value   = '';
  updateChips();
  document.getElementById('capturePanel').classList.remove('hidden');
  document.getElementById('mainShell').style.display = 'none';
  document.getElementById('mobNav').style.display = 'none';
  document.querySelector('.mob-capture-btn').style.display = 'none';
  setTimeout(()=>{ if(!document.getElementById('cpQuote').value) document.getElementById('cpQuote').focus(); }, 150);
}

function closeCapture() {
  document.getElementById('capturePanel').classList.add('hidden');
  document.getElementById('mainShell').style.display = '';
  document.getElementById('mobNav').style.display = '';
  document.querySelector('.mob-capture-btn').style.display = '';
}

function setChip(src) { curSrc = src; updateChips(); }

function updateChips() {
  document.querySelectorAll('#sourceChips .chip').forEach(c => {
    const t = c.dataset.src;
    c.className = 'chip' + (t===curSrc ? ` active-${t}` : '');
  });
}

function saveCapture() {
  const quote = document.getElementById('cpQuote').value.trim();
  if (!quote) { showToast('âš  Le texte est requis'); return; }
  const h = {
    id: Date.now().toString(), type: curSrc,
    quote,
    source: document.getElementById('cpSource').value.trim() || curSrc,
    url:    document.getElementById('cpUrl').value.trim(),
    note:   document.getElementById('cpNote').value.trim(),
    tags:   document.getElementById('cpTags').value.split(',').map(t=>t.trim()).filter(Boolean),
    date:   new Date().toISOString(), fav: false
  };
  HL.unshift(h); persist();
  closeCapture();
  renderView(curView);
  showToast('âœ¦ SauvegardÃ© !');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DETAIL SHEET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDetail(id) {
  const h = HL.find(x=>x.id===id); if(!h) return;
  const typeIco = {web:'ğŸŒ',email:'âœ‰ï¸',youtube:'â–¶ï¸',pdf:'ğŸ“„'};
  document.getElementById('detailContent').innerHTML = `
    <div class="sheet-type-pill">
      <span class="type-pill ${h.type}">${typeIco[h.type]} ${h.type}</span>
      <span style="font-size:13px;color:var(--muted);margin-left:6px">${esc(h.source)}</span>
      ${h.fav?'<span style="color:var(--gold);margin-left:6px;font-size:14px">â˜…</span>':''}
    </div>
    <div class="sheet-quote">${esc(h.quote)}</div>
    ${h.note ? `<div class="sheet-note">ğŸ’­ ${esc(h.note)}</div>` : ''}
    ${h.tags.length ? '<div class="hcard-tags" style="margin-bottom:10px">'+h.tags.map(t=>`<span class="tag">${esc(t)}</span>`).join('')+'</div>' : ''}
    ${h.url ? `<div style="font-size:12px;color:var(--blue);margin-bottom:4px;word-break:break-all">ğŸ”— ${esc(h.url)}</div>` : ''}
    <div style="font-size:12px;color:var(--muted);margin-top:8px">${new Date(h.date).toLocaleDateString('fr-FR',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}</div>`;
  document.getElementById('detailFooter').innerHTML = `
    <button class="btn" onclick="toggleFav('${id}');closeDetail()">${h.fav?'â˜… Retirer des favoris':'â˜† Ajouter aux favoris'}</button>
    <button class="btn" onclick="copyText('${id}')">â˜ Copier</button>
    <button class="btn obs" onclick="send2obs('${id}')">â—† Obsidian</button>
    <button class="btn danger" onclick="delHL('${id}');closeDetail()">ğŸ—‘ Supprimer</button>`;
  document.getElementById('detailOverlay').classList.add('open');
}

function closeDetail(e) {
  if (!e || e.target===document.getElementById('detailOverlay'))
    document.getElementById('detailOverlay').classList.remove('open');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleFav(id) {
  const h = HL.find(x=>x.id===id); if(!h) return;
  h.fav = !h.fav; persist(); renderView(curView);
  showToast(h.fav ? 'â˜… AjoutÃ© aux favoris' : 'RetirÃ© des favoris');
}

function delHL(id) {
  if (!confirm('Supprimer ce highlight ?')) return;
  HL = HL.filter(x=>x.id!==id); persist(); renderView(curView);
  showToast('SupprimÃ©');
}

function copyText(id) {
  const h = HL.find(x=>x.id===id); if(!h) return;
  navigator.clipboard?.writeText(h.quote).catch(()=>{});
  showToast('â˜ CopiÃ© !');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEARCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleSearch(q) {
  q = q.toLowerCase().trim();
  const items = !q ? HL : HL.filter(h =>
    h.quote.toLowerCase().includes(q) ||
    (h.source||'').toLowerCase().includes(q) ||
    h.tags.some(t=>t.toLowerCase().includes(q))
  );
  const map = {home:'recentGrid',all:'allGrid',web:'webGrid',email:'emailGrid',youtube:'ytGrid',pdf:'pdfGrid',fav:'favGrid'};
  if (map[curView]) renderGrid(map[curView], null, q ? items : (curView==='home'?[...HL].sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,6):HL));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OBSIDIAN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildMD(h) {
  const date = new Date(h.date).toISOString().split('T')[0];
  const tl   = {web:'Web',email:'Email',youtube:'YouTube',pdf:'PDF'};
  const tags  = h.tags.map(t=>'#'+t.replace(/\s+/g,'-')).join(' ');
  let md = `---\nsource: ${h.source}\ntype: ${tl[h.type]||h.type}\ndate: ${date}\ntags: [${h.tags.map(t=>'"'+t+'"').join(', ')}]\n---\n\n# ${h.source}\n\n> ${h.quote}\n\n`;
  if (h.note) md += `**Note :** ${h.note}\n\n`;
  if (h.url)  md += `**Source :** ${h.url}\n\n`;
  if (tags)   md += `${tags}\n\n`;
  md += `---\n*Luminary Â· ${new Date().toLocaleDateString('fr-FR')}*`;
  return md;
}

function buildURI(h) {
  if (!obsVault.trim()) return null;
  const name = (h.source||'Highlight').replace(/[\/\\:*?"<>|]/g,'').substring(0,50)+' '+h.id.slice(-4);
  const file  = obsFolder.trim() ? `${obsFolder.trim()}/${name}` : name;
  return `obsidian://new?vault=${encodeURIComponent(obsVault.trim())}&file=${encodeURIComponent(file)}&content=${encodeURIComponent(buildMD(h))}`;
}

function send2obs(id) {
  const h = HL.find(x=>x.id===id); if(!h) return;
  if (!obsVault.trim()) { showToast('âš  Configurez votre vault Obsidian'); go('obsidian'); return; }
  window.location.href = buildURI(h);
  showToast('â—† Ouverture dans Obsidianâ€¦');
}

function testObs() {
  if (!obsVault.trim()) { showToast('âš  Entrez le nom du vault'); return; }
  window.location.href = `obsidian://open?vault=${encodeURIComponent(obsVault.trim())}`;
}

function updateMdPreview() {
  const el = document.getElementById('mdPreview'); if(!el) return;
  const s = HL[0]||{source:'Paul Graham',quote:'Keep it simple.',note:'',tags:['startup'],date:new Date().toISOString(),type:'web',url:''};
  el.textContent = buildMD(s);
}

function exportAll() {
  if (!obsVault.trim()) { showToast('âš  Configurez votre vault'); return; }
  if (!confirm(`Envoyer ${HL.length} highlights dans Obsidian ?`)) return;
  HL.forEach((h,i)=>setTimeout(()=>{ const u=buildURI(h); if(u) window.location.href=u; },i*900));
  showToast(`â—† Export en coursâ€¦`);
}

function exportFavs() {
  const f=HL.filter(h=>h.fav);
  if (!obsVault.trim()) { showToast('âš  Configurez votre vault'); return; }
  if (!f.length) { showToast('Aucun favori'); return; }
  f.forEach((h,i)=>setTimeout(()=>{ const u=buildURI(h); if(u) window.location.href=u; },i*900));
  showToast(`â—† Export de ${f.length} favorisâ€¦`);
}

function dlMd() {
  const date = new Date().toISOString().split('T')[0];
  let md = `# Luminary â€” ${date}\n\n${HL.length} highlights\n\n---\n\n`;
  HL.forEach(h=>{md+=buildMD(h)+'\n\n---\n\n';});
  const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(new Blob([md],{type:'text/markdown'})),download:`luminary-${date}.md`});
  a.click(); showToast('â¬‡ Fichier .md tÃ©lÃ©chargÃ©');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIDEBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('bgOverlay').classList.toggle('show');
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('bgOverlay').classList.remove('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(m) {
  const t=document.getElementById('toast');
  t.textContent=m; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2400);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COPY HELPERS (Setup page)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function copyUrl() {
  const txt = document.getElementById('captureUrlText').textContent;
  navigator.clipboard?.writeText(txt).catch(()=>{});
  showToast('URL copiÃ©e !');
}
function copyBookmarklet() {
  const txt = document.getElementById('bkLetLink').textContent;
  navigator.clipboard?.writeText(txt).catch(()=>{});
  showToast('Bookmarklet copiÃ© !');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// URL CAPTURE (?capture=1)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkCapture() {
  const p = new URLSearchParams(window.location.search);
  if (p.get('capture') === '1') {
    history.replaceState({}, '', window.location.pathname);
    const src = p.get('src') || 'web';
    openCapture({
      quote:  decodeURIComponent(p.get('quote')||''),
      url:    decodeURIComponent(p.get('url')||''),
      source: decodeURIComponent(p.get('source')||''),
      src
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(s){ var amp='&'+'amp;',lt='&'+'lt;',gt='&'+'gt;',qt='&'+'quot;'; return String(s||'').replace(/&/g,amp).replace(/</g,lt).replace(/>/g,gt).replace(/"/g,qt); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
updateBadges();
renderHome();
checkCapture();
</script>
<script>if('serviceWorker' in navigator)navigator.serviceWorker.register('./sw.js');</script>
</body>
</html>
